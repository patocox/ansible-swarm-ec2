---

-  name: Install apt_key for Docker repo
   apt_key: keyserver=hkp://pgp.mit.edu:80 id=58118E89F3A912897C070ADBF76221572C52609D
   become: yes
   become_method: sudo   
   tags:
     - docker

-  name: Add source to docker.list file
   lineinfile: dest=/etc/apt/sources.list.d/docker.list create=yes line="deb https://apt.dockerproject.org/repo ubuntu-trusty main"
   become: yes
   become_method: sudo     
   tags:
     - docker

-  name: Install Docker
   apt: update_cache=yes name=docker-engine
   become: yes
   become_method: sudo     
   tags:
     - docker

-  name: Change permissions on /usr/local/bin
   shell: sudo chown -R $(whoami) /usr/local/bin
   tags:
     - docker

-  name: Install Docker-Machine
   get_url: url=https://github.com/docker/machine/releases/download/v0.3.0/docker-machine_linux-amd64 dest=/usr/local/bin/docker-machine 
   tags:
     - docker

-  name: Install Docker-Compose
   shell: curl -L https://github.com/docker/compose/releases/download/1.3.1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
   tags:
     - docker

-  name: Change permission on docker binaries
   file: path=/usr/local/bin/{{ item }} mode=0555
   with_items: 
     - docker-machine
     - docker-compose
   tags:
     - docker

-  name: Create Swarm Token
   shell: echo $(docker run swarm create)
   register: SWARM_TOKEN
   tags:
     - swarm

-  name: Create Swarm Master
   shell: docker-machine --debug create --driver amazonec2 --amazonec2-zone {{ AWS_ZONE }} --amazonec2-region {{ AWS_DEFAULT_REGION }} --amazonec2-access-key {{ AWS_ACCESS_KEY }} --amazonec2-secret-key {{ AWS_SECRET_KEY }} --amazonec2-vpc-id {{ AWS_VPC_ID }}  --swarm --swarm-master --swarm-discovery token://{{ SWARM_TOKEN.stdout }} swarm-master
   tags:
     - swarm

-  name: Create Swarm Nodes
   shell: docker-machine --debug create --driver amazonec2 --amazonec2-zone {{ AWS_ZONE }} --amazonec2-region {{ AWS_DEFAULT_REGION }} --amazonec2-access-key {{ AWS_ACCESS_KEY }} --amazonec2-secret-key {{ AWS_SECRET_KEY }} --amazonec2-vpc-id {{ AWS_VPC_ID }}  --swarm --swarm-discovery token://{{ SWARM_TOKEN.stdout }} swarm-node-{{ item }}
   with_sequence: count={{ NODE_COUNT }}
   tags:
     - swarm

-  name: Add public key to Swarm Master
   shell: cat ~/.ssh/authorized_keys | docker-machine ssh swarm-master 'umask 077; cat >>.ssh/authorized_keys'
   tags:
     - public_key

-  name: Add public key to Swarm Nodes
   shell: cat ~/.ssh/authorized_keys | docker-machine ssh swarm-node-{{ item }} 'umask 077; cat >>.ssh/authorized_keys'
   with_sequence: count={{ NODE_COUNT }}
   tags:
     - public_key

---

-  name: Create Admin node on EC2
   hosts: localhost
   connection: local
   gather_facts: False
   vars_files:
     - vars/external_vars.yml 

   tasks:
     
     -  name: Provision admin node on EC2
        ec2:
           aws_access_key: "{{ AWS_ACCESS_KEY }}"
           aws_secret_key: "{{ AWS_SECRET_KEY }}"
           key_name: "{{ KEY_NAME }}" 
           group: "{{ AWS_SECURITY_GROUP }}"
           instance_type: t2.micro
           image: ami-df6a8b9b
           wait: true
           vpc_subnet_id: "{{ AWS_SUBNET_ID }}"
           region: "{{ AWS_DEFAULT_REGION }}"
           assign_public_ip: yes
           instance_tags:
              Name: Admin
        tags:
          - deploy_admin
        register: admin

     -  name: Add admin node to host group
        add_host: hostname={{ item.public_ip }} groupname=admin
        with_items: admin.instances

     -  name: Wait for SSH to come up
        wait_for: host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
        with_items: admin.instances

-  name: Apply to Admin node
   hosts: admin
   remote_user: ubuntu
   vars_files:
     - vars/external_vars.yml

   roles:
     - common
     - admin
